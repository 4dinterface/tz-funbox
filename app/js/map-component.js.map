{"version":3,"sources":["../../src/map-component.js"],"names":[],"mappings":"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","file":"map-component.js","sourcesContent":["\"use strict\"\r\nvar mapModule=angular.module(\"mapComponent\", [])\r\n\r\n/**\r\n * @ngdoc directive\r\n * @name *\r\n *\r\n * @description\r\n * карта и путь\r\n *\r\n * @element DIV\r\n * @priority 0\r\n * @param {array} wayPoints \r\n * @param {array} center\r\n */\r\nclass MapComponent {\r\n  constructor(mapManager) {\r\n    MapComponent.idCount = MapComponent.idCount || 0;\r\n    this.scope = {} //в этой версии всё взаимодействие идёт через сервис\r\n\r\n    this.onDragEndWayPoint = this.onDragEndWayPoint.bind(this);   \r\n    this.mapManager=mapManager;\r\n  }\r\n\r\n  /**\r\n   * системный callback \r\n   * нужно зарегистрироватьinstance с именем взятым из id до срабатывания контролёра\r\n   * @param $scope\r\n   * @param element\r\n   * @param attr   \r\n   */\r\n  compile($element, attr){\r\n    this.id=attr.id;\r\n    \r\n    //сгенерируем id если он не указан в шаблоне    \r\n    if (!this.id) {\r\n      this.id=\"map-component-\" + (MapComponent.idCount++);\r\n      $element.attr(\"id\",this.id);            \r\n    }\r\n    //зарегистрируем instace директивы в менеджере\r\n    this.mapService=this.mapManager.registerInstance(this.id,this);\r\n        \r\n    return {\r\n      pre:($scope)=>  {\r\n        this.$scope = $scope;\r\n\r\n        // за центр и координаты целиком и полностью отвечает сервис,\r\n        // это позволяет использовать сервис в контролёре приложения не дожидаясь инициализации директивы с картой\r\n        this.$scope.center =this.mapService.center;\r\n        this.$scope.wayPoints =this.mapService.wayPoints;\r\n\r\n        ymaps.ready(this.onYandexMapReady.bind(this)); //инициализируем карту\r\n\r\n        //удалим сервис если удаляется директива\r\n        this.$scope.$on('$destroy', ()=>{\r\n          this.mapManager.unregisterInstance(this.id);\r\n        });\r\n      }           \r\n    }\r\n  }\r\n\r\n  /**\r\n   * обработик события готовности yandex map \r\n   */\r\n  onYandexMapReady() {\r\n    //create map\r\n    this.map = new ymaps.Map(this.id, {\r\n      center: this.$scope.center,\r\n      zoom: 7\r\n    });\r\n\r\n    //create point collection\r\n    this.collection = new ymaps.GeoObjectCollection({}, {\r\n      draggable: true // обьекты можно перемещать\r\n    });\r\n\r\n    this.map.geoObjects.add(this.collection);\r\n    this.$scope.$watch(\"wayPoints\", this.render.bind(this), true);\r\n\r\n    //set center\r\n    this.$scope.$watch(\"center\", this.onChangeCenter.bind(this));\r\n    this.map.events.add('boundschange', this.onBoundChange.bind(this));\r\n  }\r\n\r\n  /**\r\n   * обработчик изменения center в ысщзу\r\n   * позволяет устанавливать центр из вне\r\n   */\r\n  onChangeCenter() {\r\n    if (this.boundChange) return this.boundChange = false;\r\n    this.map.setCenter(this.$scope.center)\r\n  }\r\n\r\n  /**\r\n   * обработчик перемещения карты\r\n   * устанавливает центр\r\n   */\r\n  onBoundChange(e) {\r\n    var newCenter = e.originalEvent.newCenter;\r\n    this.$scope.$apply(() => {\r\n      this.boundChange = true;\r\n      this.$scope.center[0] = newCenter[0];\r\n      this.$scope.center[1] = newCenter[1];\r\n    });\r\n  }\r\n\r\n  /**\r\n   * обработик события dragend на placeholder\r\n   */\r\n  onDragEndWayPoint(e) {\r\n    var target = e.originalEvent.target,\r\n        index = this.collection.indexOf(target);\r\n\r\n    this.$scope.$apply(() => {\r\n      this.$scope.wayPoints[index].coordinates = target.geometry.getCoordinates();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * перерисовывает геообьекты   \r\n   */\r\n  render() {\r\n    var coordinates = this.$scope.wayPoints.map((item) => item.coordinates);\r\n\r\n    if (this.polyline) this.map.geoObjects.remove(this.polyline);\r\n    if (this.collection) this.collection.removeAll();\r\n\r\n    this.renderPoints(this.$scope.wayPoints);\r\n    this.renderPolyline(coordinates);\r\n  }\r\n\r\n  /**\r\n   * отрисовывает все точки\r\n   * @param wayPoints - массмив точек\r\n   */\r\n  renderPoints(wayPoints) {\r\n    for (let i = 0; i < wayPoints.length; i++) {\r\n      let placemark = new ymaps.Placemark(wayPoints[i].coordinates, {\r\n        balloonContent: wayPoints[i].address,\r\n        iconContent: i + 1\r\n      });\r\n\r\n      placemark.events.add(\"dragend\", this.onDragEndWayPoint)\r\n      this.collection.add(placemark);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * отрисовывает ломаные\r\n   * @param coordinates - массив точек\r\n   */\r\n  renderPolyline(coordinates) {\r\n    this.polyline = new ymaps.Polyline(coordinates);\r\n    this.polyline.options.set({\r\n      strokeColor: '#0000FF',\r\n      strokeWidth: 3,\r\n      opacity: 0.5\r\n    });\r\n    this.map.geoObjects.add(this.polyline);\r\n  }\r\n\r\n  /**\r\n   * Фабрика компонента\r\n   * @param ...args - зависимости\r\n   * @returns {MapComponent}\r\n   */\r\n  static factory(...args) {\r\n    var instance = new MapComponent(...args);\r\n    instance.link = MapComponent.prototype.link ? MapComponent.prototype.link.bind(instance) : instance.link;\r\n    return instance;\r\n  }\r\n}\r\nMapComponent.factory.$inject = [\"mapManager\"];\r\nmapModule.directive(\"mapComponent\", MapComponent.factory)\r\n\r\n\r\n/**\r\n * Сервис реализует API директивы\r\n *\r\n */\r\nclass MapService {\r\n  /* точки пути */\r\n  wayPoints;\r\n\r\n  center;\r\n\r\n  /* инстанс директивы */\r\n  _instance;\r\n\r\n  /**\r\n   * конструктор сервиса\r\n   * @param directiveInstance\r\n   */\r\n  constructor(directiveInstance) {\r\n    this._instance = directiveInstance;\r\n    this.wayPoints=[];\r\n    this.center=[55.75, 37.6];\r\n  }\r\n\r\n  /** \r\n   * Добавляет точку \r\n   * @param {string}\r\n   **/\r\n  pushPoint(name) {\r\n    this.wayPoints.push({\r\n      address:name,\r\n      coordinates: this.center.splice(0)\r\n    });\r\n  }\r\n\r\n  /** \r\n   * удаляет точку \r\n   * @param {number} index\r\n   **/\r\n  removePoint(index) {\r\n    this.wayPoints.splice(index, 1);\r\n  }\r\n\r\n  /** \r\n   * перемещает точку со старого индекса на новый\r\n   * @param {number} oldPos текущий индекс точки\r\n   * @param {number} newPos индекс для вставки\r\n   */\r\n  movePointToIndex(oldPos, newPos) {\r\n    var removePos = oldPos > newPos ? oldPos + 1 : oldPos;\r\n    this.wayPoints.splice(newPos, 0, this.wayPoints[oldPos]);\r\n    this.wayPoints.splice(removePos, 1);\r\n  }\r\n\r\n  setCenter(center) {\r\n    this.center[0] = center[0];\r\n    this.center[1] = center[1];\r\n  }\r\n}\r\n\r\n\r\n  /**\r\n   * @ngdoc service\r\n   * @name mapManager\r\n   *\r\n   * @description\r\n   * Менеджер серивисов обеспечивает регистрацию, получение и удаление сервисов директив\r\n   */\r\n  mapModule.factory('mapManager', function () {\r\n    var services = {};\r\n\r\n    function registerInstance(name, directiveInstance) {\r\n      if (!name || !directiveInstance) throw \"некорректная регистрация\";\r\n      services[name] = new MapService(directiveInstance);\r\n      return services[name];\r\n    };\r\n\r\n    function unregisterInstance(name) {\r\n      delete services[name];\r\n    };\r\n\r\n    function getServiceByName(name) {\r\n      if (!(name in services)) {\r\n        throw \"нет сервиса с именем: \" + name;\r\n      }\r\n      return services[name];\r\n    };\r\n\r\n    return {\r\n      registerInstance: registerInstance,\r\n      unregisterInstance: unregisterInstance,\r\n      getServiceByName: getServiceByName\r\n    }\r\n  })"]}