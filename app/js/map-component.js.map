{"version":3,"sources":["../../src/map-component.js"],"names":[],"mappings":"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","file":"map-component.js","sourcesContent":["\"use strict\"\r\n\r\n/**\r\n * @ngdoc directive\r\n * @name mapComponent\r\n *\r\n * @description\r\n * карта и путь\r\n *\r\n * @element DIV\r\n * @priority 0\r\n * @param {array} wayPoints \r\n * @param {array} center\r\n */\r\n\r\nclass MapComponent {\r\n\r\n  constructor() {\r\n    MapComponent.idCount = MapComponent.idCount || 0;\r\n\r\n    this.scope = {\r\n      wayPoints: \"=\",\r\n      center:\"=\"\r\n    }\r\n\r\n    this.onDragEndWayPoint = this.onDragEndWayPoint.bind(this)\r\n  }\r\n\r\n  /**\r\n   * системный callback \r\n   * @param $scope\r\n   * @param element\r\n   * @param attr   \r\n   */\r\n  link($scope, element, attr) {\r\n    this.$scope = $scope;\r\n    \r\n    //default value\r\n    this.$scope.center=this.$scope.center||[55.56, 37.76];    \r\n\r\n    //сгенерируем id если он не указан в шаблоне\r\n    this.id = attr.id || \"map-component-\" + (MapComponent.idCount++);\r\n    if (!attr.id) {\r\n      element.attr(\"id\", this.id);\r\n      element[0].setAttribute(\"id\", this.id); //сработает синхронно, в отличии от element.attr срабатывающегот асинхронно        \r\n    }\r\n\r\n    ymaps.ready(this.onYandexMapReady.bind(this)); //инициализируем карту            \r\n  }\r\n\r\n  /**\r\n   * обработик события готовности yandex map \r\n   */\r\n  onYandexMapReady() {\r\n    //create map\r\n    this.map = new ymaps.Map(this.id, {\r\n      center: this.$scope.center,\r\n      zoom: 7\r\n    });\r\n    \r\n    //create point collection\r\n    this.collection = new ymaps.GeoObjectCollection({}, {\r\n      draggable: true // обьекты можно перемещать\r\n    });\r\n    \r\n    this.map.geoObjects.add(this.collection);    \r\n    this.$scope.$watch(\"wayPoints\", this.update.bind(this), true);\r\n    \r\n    //set center\r\n    this.$scope.$watch(\"center\", this.onChangeCenter.bind(this) );\r\n    this.map.events.add('boundschange', this.onBoundChange.bind(this) );\r\n  }\r\n  \r\n  /**\r\n   * обработчик изменения center в ысщзу\r\n   * позволяет устанавливать центр из вне\r\n   */\r\n  onChangeCenter(){\r\n    if(this.boundChange) return this.boundChange=false;\r\n    this.map.setCenter(this.$scope.center)  \r\n  }\r\n  \r\n  /**\r\n   * обработчик перемещения карты\r\n   * устанавливает центр в scope\r\n   */\r\n  onBoundChange(e){        \r\n    var newCenter=e.originalEvent.newCenter;\r\n    this.$scope.$apply(()=>{\r\n      this.boundChange=true;\r\n      this.$scope.center[0] = newCenter[0];\r\n      this.$scope.center[1] = newCenter[1];\r\n    });    \r\n  }  \r\n  \r\n  /**\r\n   * обработик события dragend на placeholder\r\n   */\r\n  onDragEndWayPoint(e) {\r\n    var target = e.originalEvent.target,\r\n        index = this.collection.indexOf(target),\r\n        coordinates = target.geometry.getCoordinates();\r\n\r\n    this.$scope.$apply(() => {\r\n      this.$scope.wayPoints[index].coordinates = coordinates;\r\n    });\r\n    \r\n  }\r\n  \r\n\r\n  /**\r\n   * обновляет карту\r\n   * @param actual - waayPoints после изменения\r\n   * @param old - waayPoints после изменения   \r\n   * @returns {MapComponent}\r\n   */\r\n  update(actual, old) { \r\n    //установим координаты новым точкам\r\n    this.$scope.wayPoints.forEach((wayPoint)=>{\r\n      wayPoint.coordinates=wayPoint.coordinates||this.$scope.center.slice(0)\r\n    })    \r\n    this.render();\r\n  }\r\n  \r\n  /**\r\n   * перерисовывает геообьекты   \r\n   */\r\n  render() {\r\n    var coordinates = this.$scope.wayPoints.map((item) => item.coordinates);\r\n\r\n    if (this.polyline) this.map.geoObjects.remove(this.polyline);\r\n    if (this.collection) this.collection.removeAll();    \r\n\r\n    this.renderPoints(this.$scope.wayPoints);    \r\n    this.renderPolyline(coordinates);\r\n  }\r\n  \r\n  /**\r\n   * отрисовывает все точки\r\n   * @param wayPoints - массмив точек\r\n   */\r\n  renderPoints(wayPoints) {\r\n    for (let i = 0; i < wayPoints.length; i++) {\r\n      let placeMark = new ymaps.Placemark(wayPoints[i].coordinates, {\r\n        balloonContent: wayPoints[i].address,\r\n        iconContent: i + 1\r\n      });\r\n\r\n      placeMark.events.add(\"dragend\", this.onDragEndWayPoint)\r\n      this.collection.add(placeMark);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * отрисовывает ломаные\r\n   * @param coordinates - массив точек\r\n   */\r\n  renderPolyline(coordinates) {\r\n    this.polyline = new ymaps.Polyline(coordinates);\r\n    this.polyline.options.set({\r\n        strokeColor: '#0000FF',\r\n        strokeWidth: 3,\r\n        opacity: 0.5\r\n      }); \r\n    this.map.geoObjects.add(this.polyline);\r\n  }  \r\n\r\n  /**\r\n   * Фабрика компонента\r\n   * @param ...args - зависимости\r\n   * @returns {MapComponent}\r\n   */\r\n  static factory(...args) {\r\n    var instance = new MapComponent(...args);\r\n    instance.link = MapComponent.prototype.link ? MapComponent.prototype.link.bind(instance) : instance.link;\r\n    return instance;\r\n  }\r\n}\r\n\r\nMapComponent.factory.$inject = [];\r\nangular.module(\"mapComponent\", []).directive(\"mapComponent\", MapComponent.factory);"]}