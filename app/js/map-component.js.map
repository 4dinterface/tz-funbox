{"version":3,"sources":["../../src/map-component.js"],"names":[],"mappings":"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","file":"map-component.js","sourcesContent":["\"use strict\"\r\n\r\nclass MapComponent {\r\n\r\n  constructor() {\r\n    MapComponent.idCount = MapComponent.idCount || 0;\r\n\r\n    this.scope = {\r\n      wayPoints: \"=\",\r\n      modePath: \"=\"\r\n    }\r\n\r\n    this.onDragEndWayPoint = this.onDragEndWayPoint.bind(this)\r\n  }\r\n\r\n  /**\r\n   * системный callback \r\n   * @param $scope\r\n   * @param element\r\n   * @param attr   \r\n   */\r\n  link($scope, element, attr) {\r\n    this.$scope = $scope;\r\n\r\n    //сгенерируем id если он не указан в шаблоне\r\n    this.id = attr.id || \"map-component-\" + (MapComponent.idCount++);\r\n    if (!attr.id) {\r\n      element.attr(\"id\", this.id);\r\n      element[0].setAttribute(\"id\", this.id); //сработает синхронно, в отличии от element.attr срабатывающегот асинхронно        \r\n    }\r\n\r\n    ymaps.ready(this.onYandexMapReady.bind(this)); //инициализируем карту            \r\n  }\r\n\r\n  /**\r\n   * обработик события готовности yandex map \r\n   */\r\n  onYandexMapReady() {\r\n    //create map\r\n    this.map = new ymaps.Map(this.id, {\r\n      center: [55.56, 37.76],\r\n      zoom: 7\r\n    });\r\n\r\n    //create point collection\r\n    this.collection = new ymaps.GeoObjectCollection({}, {\r\n      draggable: true // и их можно перемещать\r\n    });\r\n    this.map.geoObjects.add(this.collection);\r\n\r\n\r\n    this.$scope.$watch(\"wayPoints\", this.update.bind(this), true);\r\n    this.$scope.$watch(\"modePath\", this.render.bind(this));\r\n  }\r\n\r\n  /**\r\n   * обработик события dragend на placeholder\r\n   */\r\n  onDragEndWayPoint(e) {\r\n    var target = e.originalEvent.target,\r\n      pos = this.collection.indexOf(target),\r\n      coordinates = target.geometry.getCoordinates();\r\n\r\n    ymaps.geocode(coordinates, {\r\n      results: 1\r\n    }).then((res) => {\r\n      var obj = res.geoObjects.get(0),\r\n        detail = obj.properties.get('metaDataProperty').GeocoderMetaData;\r\n\r\n      this.$scope.$apply(() => {\r\n        this.$scope.wayPoints[pos].coordinates = coordinates;\r\n        this.$scope.wayPoints[pos].address = detail.text;\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * обновляет карту\r\n   * @param actual - waayPoints после изменения\r\n   * @param old - waayPoints после изменения   \r\n   * @returns {MapComponent}\r\n   */\r\n  update(actual, old) {\r\n    if (old && actual.length > old.length) {\r\n      ymaps.geocode(actual[actual.length - 1].address, {\r\n        results: 1\r\n      }).then((res) => {\r\n        if (!res || !res.geoObjects.get(0)) return;\r\n        var coord = res.geoObjects.get(0).geometry.getCoordinates();\r\n\r\n        this.$scope.$apply(() => {\r\n          this.map.setCenter(coord);\r\n          actual[actual.length - 1].coordinates = coord;\r\n          actual[actual.length - 1].goodAddress = true;\r\n        });\r\n      })\r\n    } else {\r\n      this.render(actual);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * перерисовывает геообьекты   \r\n   */\r\n  render() {\r\n    var wayPoints = this.$scope.wayPoints.filter((point) => point.coordinates),\r\n      coordinates = wayPoints.map((item) => item.coordinates);\r\n\r\n    if (this.polyline) this.map.geoObjects.remove(this.polyline);\r\n    if (this.path) this.map.geoObjects.remove(this.path);\r\n    if (this.collection) this.collection.removeAll();\r\n\r\n    this.renderPoints(wayPoints);\r\n\r\n    //путь или линия рисуются только в случае если все точки найдены\r\n    if (this.$scope.wayPoints.length == wayPoints.length) {\r\n      if (this.$scope.modePath) this.renderRoute(wayPoints, coordinates)\r\n      else this.renderPolyline(wayPoints, coordinates);\r\n    }\r\n  }\r\n\r\n  renderPoints(wayPoints) {\r\n    for (let i = 0; i < wayPoints.length; i++) {\r\n      let placeMark = new ymaps.Placemark(wayPoints[i].coordinates, {\r\n        balloonContent: wayPoints[i].address,\r\n        iconContent: i + 1\r\n      });\r\n\r\n      placeMark.events.add(\"dragend\", this.onDragEndWayPoint)\r\n      this.collection.add(placeMark);\r\n    }\r\n  }\r\n\r\n  renderPolyline(wayPoints, coordinates) {\r\n    this.polyline = new ymaps.Polyline(coordinates);\r\n    this.polyline.options.set({\r\n        strokeColor: '#0000FF',\r\n        strokeWidth: 3,\r\n        opacity: 0.5\r\n      }); \r\n    this.map.geoObjects.add(this.polyline);\r\n  }\r\n\r\n\r\n  renderRoute(wayPoints, coordinates) {\r\n    ymaps.route(coordinates).then((route) => {\r\n      this.path = route.getPaths();\r\n\r\n      this.path.options.set({\r\n        strokeColor: '#FF0000',\r\n        strokeWidth: 2\r\n      });\r\n      this.map.geoObjects.add(this.path);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Фабрика компонента\r\n   * @param ...args - зависимости\r\n   * @returns {MapComponent}\r\n   */\r\n  static factory(...args) {\r\n    var instance = new MapComponent(...args);\r\n    instance.link = MapComponent.prototype.link ? MapComponent.prototype.link.bind(instance) : instance.link;\r\n    return instance;\r\n  }\r\n}\r\n\r\nMapComponent.factory.$inject = [];\r\nangular.module(\"mapComponent\", []).directive(\"mapComponent\", MapComponent.factory);"]}